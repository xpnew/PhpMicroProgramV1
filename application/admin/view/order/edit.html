<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{$title}</title>
    <link rel="stylesheet" href="__PUBLIC__lib/layui-v2.11.6/css/layui.css" media="all">
    <link rel="stylesheet" href="__PUBLIC__css/public.css" media="all">
    <link rel="stylesheet" href="__PUBLIC__css/pagescss/butjumpup.css" />
    <script type="text/javascript" src="__PUBLIC__scripts/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__scripts/comm.js"></script>

</head>
<body>
    <div class="layuimini-container">
        <div class="layuimini-main">


            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>{$title}</legend>
            </fieldset>

            <form class="layui-form" action="" lay-filter="MainForm">
<input type="hidden" name="Id" id="Id" value="" /><!-- 主键Id  -->
<input type="hidden" name="OrderNo" id="OrderNo" value="" /><!-- 订单号  -->
<input type="hidden" name="OrderCode" id="OrderCode" value="" /><!-- 订单编码  -->
<input type="hidden" name="TotalQty" id="TotalQty" value="" /><!-- 总数量  -->
<input type="hidden" name="Weight" id="Weight" value="" /><!-- 总重量  -->
<input type="hidden" name="UserId" id="UserId" value="" /><!-- 用户Id  -->
<input type="hidden" name="UnitPrice" id="UnitPrice" value="" /><!-- 单价  -->
<input type="hidden" name="TotalPrice" id="TotalPrice" value="" /><!-- 总价  -->
<input type="hidden" name="CreateTime" id="CreateTime" value="" /><!-- 创建时间  -->
<input type="hidden" name="UpdateTime" id="UpdateTime" value="" /><!-- 更新时间  -->
<input type="hidden" name="Remark" id="Remark" value="" /><!-- 备注  -->
<input type="hidden" name="AuditUser" id="AuditUser" value="" /><!-- 审核人  -->
<input type="hidden" name="AuditTime" id="AuditTime" value="" /><!-- 审核时间  -->
<input type="hidden" name="AuditStatusId" id="AuditStatusId" value="" /><!-- 审核状态  -->
<input type="hidden" name="Temp1" id="Temp1" value="" /><!--   -->
<input type="hidden" name="Temp2" id="Temp2" value="" /><!--   -->
<input type="hidden" name="OrderStatus" id="OrderStatus" value="" /><!-- 10001000 未完成 ;10005000 已经完成  etc.  -->
<input type="hidden" name="PayStatus" id="PayStatus" value="" /><!-- 20001000 未付款;20002000 付款中;20004000 已经取消;20005000 付款成功;20005500 退款;20009000 支付失败  -->
<input type="hidden" name="DeliveryPrice" id="DeliveryPrice" value="" /><!-- 运费  -->
<input type="hidden" name="PayPrice" id="PayPrice" value="" /><!-- 实付金额  -->
<input type="hidden" name="ClientAddress" id="ClientAddress" value="" /><!-- 客户地址  -->
<input type="hidden" name="ClientPhone" id="ClientPhone" value="" /><!-- 客户电话  -->
<input type="hidden" name="ClientName" id="ClientName" value="" /><!-- 客户姓名  -->

             

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">订单号</label>
                        <div class="layui-input-inline layui-text layui-text-form layui-input-block">
                            {$Model.OrderNo}                            
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">总数量</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.TotalQty}
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">总价</label>
                        <div class="layui-input-inline  layui-text-form">
                            {$Model.TotalPrice}
                        </div>
                    </div>

                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">收货人姓名</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.ClientName}
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">手机</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.ClientPhone}
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">地址</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.ClientAddress}
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">创建时间</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.CreateTime}
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">更新时间</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.UpdateTime}
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">付款时间</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.PayTime}
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">发货时间</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.ShipingTime}
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">到货时间</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.ArrivalTime}
                        </div>
                    </div>

                </div>

                {if( 10002000 == $Model -> OrderStatus)}

                <div class="layui-form-item">

                    <div class="layui-inline">
                        <label class="layui-form-label">运单号</label>
                        <div class="layui-input-inline">
                            <input type="text" name="TrackingNumber" lay-verify="required" autocomplete="off" class="layui-input" />
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">发货姓名</label>
                        <div class="layui-input-inline">
                            <input type="text" name="ShippingName" lay-verify="required"  class="layui-input"/>
                        </div>
                    </div>

                </div>
                <div class="layui-form-item  layui-form-text">
                    <label class="layui-form-label">发货地址</label>
                    <div class="layui-input-block">
                        <textarea placeholder="" name="ShippingAddress" autocomplete="off" class="layui-textarea"></textarea>
                    </div>
                </div>                
                {else}
                <div class="layui-form-item">
                <input type="hidden" name="TrackingNumber" id="TrackingNumber" value="" /><!-- 运单号  -->
                <input type="hidden" name="ShippingAddress" id="ShippingAddress" value="" /><!-- 发货地址  -->
                <input type="hidden" name="ShippingName" id="ShippingName" value="" /><!-- 发货姓名  -->

                    <div class="layui-inline">
                        <label class="layui-form-label">运单号</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.TrackingNumber}
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">发货姓名</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.ShippingName}
                        </div>
                    </div>
                    <div class="layui-inline ">
                        <label class="layui-form-label">发货地址</label>
                        <div class="layui-input-inline layui-text layui-text-form">
                            {$Model.ShippingAddress}
                        </div>
                    </div>

                </div>

                {/if}
                <div class="layui-form-item">
                    <div class="layui-input-block">

                    {if( 10002000 == $Model -> OrderStatus)}
                        <button class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    {else}
                        <button type="button" class="layui-btn layui-btn-primary  layui-border-green"" onclick="bt_close()">关闭</button>
                    {/if}   
                    </div>
                </div>

        
            </form>
        </div>
    </div>
    <div class="layuimini-container">
        <div class="layuimini-main">
            <table class="layui-hide" id="ItmesTable" lay-filter="ItmesTable"></table>
            <!-- 商品 -->
            <script type="text/html" id="TPL-ProductName">
                <input type="text" class="layui-input selectproduct" lay-verify="required" readonly="readonly" lay-on="ProductJsonSelector" placeholder="点击选择商品" value="{{= d.ProductName || '' }}">
            </script>

            <!-- 采购数量 -->
            <script type="text/html" id="TPL-Number-Qty">
                <input type="text" lay-affix="number" name="Qty" class="layui-input setnumer" lay-input-mirror="{{= d.Qty || '' }}" placeholder="输入采购数量" onchange="NumberChange(this);">

            </script>
            <script type="text/html" id="ItmesRightBar">
                <a class="layui-btn layui-btn-normal layui-btn-xs data-count-edit" lay-event="SelectQuotation">选择报价</a>
            </script>

        </div>
    </div>

    <script src="__PUBLIC__lib/layui-v2.11.6/layui.js" charset="utf-8"></script>
    <script>
        layui.use(['form', 'table', 'jquery'], function () {
            let $ = layui.jquery,
                form = layui.form,
                table = layui.table;
            var util = layui.util;
            var upload = layui.upload;
            var element = layui.element;
            // 自定义验证规则
            form.verify({
                // 确认密码
                confirmPassword: function (value, item) {
                    var passwordValue = $('#RegPwd').val();
                    if (value !== passwordValue) {
                        return '两次密码输入不一致';
                    }
                }

            });



            //监听提交
            form.on('submit(demo1)', function (data) {
                console.log(data);
                Debug(data);
                // if (CheckNull(data.field.EmployeeTypeId)) {
                //     layer.alert('请选择 职员类型', { icon: 5 });
                //     return false;
                // }

                //if (null != data) return false;

                $.ajax({
                    url: '/{$Request.module}/{$Request.controller}/save',
                    type: 'post',
                    dataType: 'json',
                    data: data.field,
                    success: function (data) {
                        console.log(data);
                        //Info,Success,Warning,Error
                        var type = data.Type;
                        if (0 < data.StatusCode) {
                            layer.msg(data.Title, { icon: 6, time: 2000 },
                                function () {
                                    var index = parent.layer.getFrameIndex(window.name);
                                    parent.layer.close(index);

                                    if (parent.ReloadList)
                                        parent.ReloadList();
                                    if (parent.layer.RefreshTable)
                                        parent.layer.RefreshTable();
                                });

                        } else {
                            layer.alert(data.Title, { icon: 5 });
                        }
                    }
                });
                //layer.alert(JSON.stringify(data.field), {
                //    title: '最终的提交信息'
                //})
                return false;
            });


                        //表单初始赋值
            form.val('MainForm', {

                "Id": "{$Model->Id}" //Id主键
, "OrderNo": "{$Model->OrderNo|default=''}" // 订单号
, "OrderCode": "{$Model->OrderCode|default=''}" // 订单编码
, "TotalQty": "{$Model->TotalQty|default=''}" // 总数量
, "Weight": "{$Model->Weight|default=''}" // 总重量
, "UserId": "{$Model->UserId|default=''}" // 用户Id
, "UnitPrice": "{$Model->UnitPrice|default=''}" // 单价
, "TotalPrice": "{$Model->TotalPrice|default=''}" // 总价 
, "CreateTime": "{$Model->CreateTime|default=''}" // 创建时间
, "UpdateTime": "{$Model->UpdateTime|default=''}" // 更新时间
, "Remark": "{$Model->Remark|default=''}" // 备注
, "AuditUser": "{$Model->AuditUser|default=''}" // 审核人
, "AuditTime": "{$Model->AuditTime|default=''}" // 审核时间
, "AuditStatusId": "{$Model->AuditStatusId|default=''}" // 审核状态
, "Temp1": "{$Model->Temp1|default=''}" //
, "Temp2": "{$Model->Temp2|default=''}" //
, "OrderStatus": "{$Model->OrderStatus|default=''}" // 10001000 未完成 ;10005000 已经完成  etc.
, "PayStatus": "{$Model->PayStatus|default=''}" // 20001000 未付款;20002000 付款中;20004000 已经取消;20005000 付款成功;20005500 退款;20009000 支付失败
, "DeliveryPrice": "{$Model->DeliveryPrice|default=''}" // 运费
, "PayPrice": "{$Model->PayPrice|default=''}" // 实付金额
, "ClientAddress": "{$Model->ClientAddress|default=''}" // 客户地址
, "ClientPhone": "{$Model->ClientPhone|default=''}" // 客户电话
, "ClientName": "{$Model->ClientName|default=''}" // 客户姓名
, "TrackingNumber": "{$Model->TrackingNumber|default=''}" // 运单号
, "ShippingAddress": "{$Model->ShippingAddress|default=''}" // 发货地址
, "ShippingName": "{$Model->ShippingName|default=''}" // 发货姓名
, "PayTime": "{$Model->PayTime|default=''}" // 付款时间
, "ShipingTime": "{$Model->ShipingTime|default=''}" // 发货时间
, "ArrivalTime": "{$Model->ArrivalTime|default=''}" // 到货时间

            })


 ///-----------------------  子表部分

    table.render({
        elem: '#ItmesTable',
        toolbar: '#ItemsTopBar', //  上部工具栏
                method: 'post',
                url: '/{$Request.module}/{$Request.controller}/QueryItems',
                request: {
                    pageName: 'PageIndex' //页码的参数名称，默认：page
                    , limitName: 'PageSize' //每页数据量的参数名，默认：limit
                    
                },
                where: {
                    OrderId: $('#Id').val()
                },
                //data: [{
                //    'privatestyle': '张三',
                //    'erptype': '2301',
                //    'labels': '膳寇'
                //},               ],
                defaultToolbar: [],
                cols: [
                    [{
                        type: 'numbers',
                        title: '序号'
                    },
                  
                    {field: 'OrderNo',title: '订单号',align: 'center'},
                    {field: 'SourceItemId',title: '来源Id',align: 'center'},
                    {field: 'ProductName',title: '商品名称',align: 'center'},
                    {field: 'ProductCode',title: '商品代码',align: 'center'},
                    {field: 'ProductPic',title: '商品图片',align: 'center',
                         templet: function (d) {
                            if (!CheckNull(d.ProductPic)) {
                                return '<img src="' + d.ProductPic + '" style="height:30px;" />';
                            } else {
                                return '';
                            }
                        }
                    },
                    {field: 'Summary',title: '商品摘要',align: 'center'},
                    {field: 'Qty',title: '数量',align: 'center'},
                    {field: 'Weight',title: '重量',align: 'center'},
                    {field: 'LineRmk',title: '行备注',align: 'center'},
                    {field: 'IsLock',title: '锁定',align: 'center'},
                    {field: 'UnitPrice',title: '单价',align: 'center'},
                    {field: 'TotalPrice',title: '总价',align: 'center'},


                    ]
        ],
        done: function (res, curr, count, origin) {


        },
                page: true,
                limit: 99999,
                limits: [10, 15, 20, 25, 50, 100],
                skin: 'grid'
    });

    /**
       * tool 右边操作区区 监听事件
       */
    table.on('tool(ItmesTable)', function (obj) {
            var ModelData = obj.data;
        if (obj.event === 'edit') {  // 监听添加操作
            var Path = '/{$Request.module}/{$Request.controller}/QueryItems';
            Path += '?_dx=' + Math.random() + '&id=' + ModelData.Id;
            var index = layer.open({
                title: '修改',
                type: 2,
                shade: 0.2,
                maxmin: true,
                shadeClose: false,
                area: ['830px', '575px'],
                content: Path,
            //    end: function () {
            //        RefreshTable();
            //    }
            });
            $(window).on("resize", function () {
                layer.full(index);
            });
                return false;

        } else if (obj.event === 'SelectQuotation') {
            var ModelData = obj.data;

            Debug('event date', obj);
            Window.CurrentItem = { index: obj.index, data: ModelData };
            var Path = "/Selector/SupplierQuotation?PageSize=99999&ProductId=" + ModelData.ProductId + "&ProductName=" + ModelData.ProductName + "&OrderNo=" + ModelData.OrderNo + "&OrderId=" + ModelData.OrderId ;
                Path += '&_dx=' + Math.random();
                layer.open({
                    type: 2,
                    area: ['90%', '90%'],
                    title: false, // 不显示标题栏
                    closeBtn: 0,
                    shadeClose: true, // 点击遮罩关闭层
                    content: Path,
                    end: function () {
                        // layer.msg('关闭后的回调', {icon:6});
                    }
                });


        }
    });




        });


    function bt_close(){
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    }



    </script>
</body>
</html>